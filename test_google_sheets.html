<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Sheets API 테스트</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        .test-title {
            font-weight: bold;
            color: #495057;
            margin-bottom: 10px;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 14px;
        }
        .status.loading {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        .status.success {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .results {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 5px;
            border: 1px solid #dee2e6;
            max-height: 400px;
            overflow-y: auto;
        }
        .vehicle-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .vehicle-item:last-child {
            border-bottom: none;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .config-section {
            background: #e9ecef;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .config-item {
            margin: 10px 0;
        }
        .config-item label {
            display: inline-block;
            width: 150px;
            font-weight: bold;
        }
        .config-item input {
            width: 400px;
            padding: 5px;
            border: 1px solid #ced4da;
            border-radius: 4px;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 Google Sheets API 테스트</h1>
        
        <!-- 설정 섹션 -->
        <div class="config-section">
            <h3>API 설정</h3>
            <div class="config-item">
                <label>API Key:</label>
                <input type="text" id="apiKey" value="AIzaSyC2WdvJ29WTuvjkuCBGDwwiIMmmKll59ws" />
            </div>
            <div class="config-item">
                <label>Spreadsheet ID:</label>
                <input type="text" id="spreadsheetId" value="1-r-TPHcy0TBAMmnytN510pKV3npE0b5M-hqQQIm3ddA" />
            </div>
        </div>

        <!-- 테스트 1: API 키 검증 -->
        <div class="test-section">
            <div class="test-title">테스트 1: API 키 및 스프레드시트 접근 검증</div>
            <button onclick="testAPIAccess()">API 접근 테스트</button>
            <div id="test1-status"></div>
            <div id="test1-results" class="results" style="display:none;"></div>
        </div>

        <!-- 테스트 2: 시트 목록 가져오기 -->
        <div class="test-section">
            <div class="test-title">테스트 2: 스프레드시트의 시트 목록 가져오기</div>
            <button onclick="getSheetsList()">시트 목록 조회</button>
            <div id="test2-status"></div>
            <div id="test2-results" class="results" style="display:none;"></div>
        </div>

        <!-- 테스트 3: 제조사와 모델명 데이터 가져오기 -->
        <div class="test-section">
            <div class="test-title">테스트 3: 제조사와 모델명 데이터 가져오기</div>
            <button onclick="getManufacturerData()">데이터 가져오기</button>
            <div id="test3-status"></div>
            <div id="test3-results" class="results" style="display:none;"></div>
        </div>

        <!-- 테스트 4: 특정 범위 데이터 가져오기 -->
        <div class="test-section">
            <div class="test-title">테스트 4: 특정 범위 데이터 테스트</div>
            <div class="config-item">
                <label>Range (예: A1:C10):</label>
                <input type="text" id="testRange" value="2025 서울특별시!A1:G10" />
            </div>
            <button onclick="getSpecificRange()">범위 데이터 가져오기</button>
            <div id="test4-status"></div>
            <div id="test4-results" class="results" style="display:none;"></div>
        </div>
    </div>

    <script>
        // API 설정 가져오기
        function getConfig() {
            return {
                apiKey: document.getElementById('apiKey').value,
                spreadsheetId: document.getElementById('spreadsheetId').value
            };
        }

        // 상태 표시 헬퍼 함수
        function showStatus(elementId, message, type = 'loading') {
            const element = document.getElementById(elementId);
            element.className = `status ${type}`;
            element.textContent = message;
        }

        // 결과 표시 헬퍼 함수
        function showResults(elementId, content) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.innerHTML = content;
        }

        // 테스트 1: API 키 검증
        async function testAPIAccess() {
            const config = getConfig();
            showStatus('test1-status', 'API 접근 테스트 중...', 'loading');
            
            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${config.spreadsheetId}?key=${config.apiKey}`;
                console.log('요청 URL:', url);
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (response.ok) {
                    showStatus('test1-status', '✅ API 접근 성공!', 'success');
                    showResults('test1-results', `
                        <h4>스프레드시트 정보:</h4>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `);
                } else {
                    throw new Error(`HTTP ${response.status}: ${data.error?.message || '알 수 없는 오류'}`);
                }
            } catch (error) {
                showStatus('test1-status', `❌ 오류: ${error.message}`, 'error');
                showResults('test1-results', `
                    <h4>오류 상세:</h4>
                    <p>${error.message}</p>
                    <h4>가능한 원인:</h4>
                    <ul>
                        <li>API 키가 유효하지 않음</li>
                        <li>Google Sheets API가 활성화되지 않음</li>
                        <li>스프레드시트가 공개되지 않음</li>
                        <li>스프레드시트 ID가 잘못됨</li>
                    </ul>
                `);
            }
        }

        // 테스트 2: 시트 목록 가져오기
        async function getSheetsList() {
            const config = getConfig();
            showStatus('test2-status', '시트 목록 조회 중...', 'loading');
            
            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${config.spreadsheetId}?key=${config.apiKey}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (response.ok) {
                    const sheets = data.sheets || [];
                    showStatus('test2-status', `✅ ${sheets.length}개의 시트를 찾았습니다!`, 'success');
                    
                    let html = '<h4>시트 목록:</h4><ul>';
                    sheets.forEach(sheet => {
                        html += `<li>${sheet.properties.title} (ID: ${sheet.properties.sheetId})</li>`;
                    });
                    html += '</ul>';
                    
                    showResults('test2-results', html);
                } else {
                    throw new Error(`HTTP ${response.status}: ${data.error?.message || '알 수 없는 오류'}`);
                }
            } catch (error) {
                showStatus('test2-status', `❌ 오류: ${error.message}`, 'error');
            }
        }

        // 테스트 3: 제조사와 모델명 데이터 가져오기
        async function getManufacturerData() {
            const config = getConfig();
            showStatus('test3-status', '차량 데이터 로드 중...', 'loading');
            
            try {
                // 서울특별시 시트에서 데이터 가져오기
                const range = encodeURIComponent('2025 서울특별시!A:G');
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${config.spreadsheetId}/values/${range}?key=${config.apiKey}`;
                
                console.log('요청 URL:', url);
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (response.ok) {
                    const rows = data.values || [];
                    
                    if (rows.length > 0) {
                        // 헤더 확인
                        const headers = rows[0];
                        console.log('헤더:', headers);
                        
                        // 데이터 파싱 (헤더 제외)
                        const vehicles = [];
                        for (let i = 1; i < Math.min(rows.length, 20); i++) { // 최대 20개만 표시
                            const row = rows[i];
                            if (row[0] && row[2] && row[3]) { // 제조사, 모델명, 국고보조금
                                vehicles.push({
                                    manufacturer: row[0],
                                    model: row[2],
                                    nationalSubsidy: row[3]
                                });
                            }
                        }
                        
                        showStatus('test3-status', `✅ ${vehicles.length}개의 차량 데이터를 가져왔습니다!`, 'success');
                        
                        let html = '<h4>차량 데이터 (상위 20개):</h4>';
                        vehicles.forEach(vehicle => {
                            html += `<div class="vehicle-item">
                                <strong>${vehicle.manufacturer}</strong> - ${vehicle.model}<br>
                                국고보조금: ${vehicle.nationalSubsidy}만원
                            </div>`;
                        });
                        
                        showResults('test3-results', html);
                    } else {
                        throw new Error('데이터가 없습니다');
                    }
                } else {
                    throw new Error(`HTTP ${response.status}: ${data.error?.message || '알 수 없는 오류'}`);
                }
            } catch (error) {
                showStatus('test3-status', `❌ 오류: ${error.message}`, 'error');
                showResults('test3-results', `
                    <h4>오류 상세:</h4>
                    <p>${error.message}</p>
                    <p>시트 이름이나 범위를 확인해주세요.</p>
                `);
            }
        }

        // 테스트 4: 특정 범위 데이터 가져오기
        async function getSpecificRange() {
            const config = getConfig();
            const range = document.getElementById('testRange').value;
            showStatus('test4-status', `'${range}' 범위 데이터 로드 중...`, 'loading');
            
            try {
                const encodedRange = encodeURIComponent(range);
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${config.spreadsheetId}/values/${encodedRange}?key=${config.apiKey}`;
                
                console.log('요청 URL:', url);
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (response.ok) {
                    const rows = data.values || [];
                    showStatus('test4-status', `✅ ${rows.length}개의 행을 가져왔습니다!`, 'success');
                    
                    let html = '<h4>데이터:</h4><pre>';
                    html += JSON.stringify(rows, null, 2);
                    html += '</pre>';
                    
                    showResults('test4-results', html);
                } else {
                    throw new Error(`HTTP ${response.status}: ${data.error?.message || '알 수 없는 오류'}`);
                }
            } catch (error) {
                showStatus('test4-status', `❌ 오류: ${error.message}`, 'error');
                showResults('test4-results', `
                    <h4>오류 상세:</h4>
                    <p>${error.message}</p>
                    <h4>올바른 범위 형식:</h4>
                    <ul>
                        <li>시트이름!A1:B10</li>
                        <li>'시트 이름'!A:G (공백이 있는 경우 따옴표 사용)</li>
                        <li>A1:C10 (기본 시트)</li>
                    </ul>
                `);
            }
        }

        // 페이지 로드 시 자동으로 API 테스트 실행
        window.onload = function() {
            console.log('Google Sheets API 테스트 페이지 로드 완료');
        };
    </script>
</body>
</html>